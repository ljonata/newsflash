<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Defense</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: #1a1a2e;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 300;
        }
        #user-info {
            color: #fff;
            font-size: 14px;
        }
        #user-info .username { color: gold; font-weight: bold; }
        #user-info .coins { color: lime; margin-left: 15px; }
        .nav-links { display: flex; gap: 15px; }
        .nav-links a {
            color: #e94560;
            font-size: 14px;
            text-decoration: none;
            cursor: pointer;
        }
        .nav-links a:hover { color: #fff; text-decoration: underline; }

        #game-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 55px;
            gap: 10px;
        }
        h1 {
            color: gold;
            font-size: 28px;
            text-shadow: 2px 2px 4px #000;
        }
        #status-bar {
            display: flex;
            gap: 25px;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
        }
        #status-bar .wave-info { color: #ff9800; }
        #status-bar .kills-info { color: #e94560; }

        #game-area {
            display: flex;
            gap: 0;
        }

        /* ===== PLANT PANEL (left side) ===== */
        #plant-panel {
            display: flex;
            flex-direction: column;
            background-color: #16213e;
            border: 3px solid #555;
            border-right: none;
            width: 80px;
        }
        #sun-display {
            text-align: center;
            padding: 8px 4px;
            background-color: #1a1a2e;
            border-bottom: 2px solid #555;
        }
        #sun-icon {
            font-size: 24px;
            display: block;
        }
        #sun-count {
            color: #ffdd00;
            font-size: 16px;
            font-weight: bold;
        }
        .plant-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 4px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            transition: background-color 0.15s;
            position: relative;
        }
        .plant-option:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .plant-option.selected {
            background-color: rgba(76, 175, 80, 0.3);
            box-shadow: inset 0 0 0 2px #4CAF50;
        }
        .plant-option.disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }
        .plant-option .plant-preview {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            margin-bottom: 3px;
            position: relative;
        }
        .plant-option .plant-name {
            color: #ccc;
            font-size: 9px;
            text-align: center;
        }
        .plant-option .plant-cost {
            color: #ffdd00;
            font-size: 10px;
            font-weight: bold;
        }

        /* Plant preview shapes in panel */
        .preview-peashooter {
            background: radial-gradient(circle at 40% 40%, #66bb6a, #2e7d32);
            border-radius: 50%;
        }
        .preview-sunflower {
            background: radial-gradient(circle at 40% 40%, #ffee58, #f9a825);
            border-radius: 50%;
        }
        .preview-wallnut {
            background: radial-gradient(circle at 40% 40%, #a1887f, #6d4c41);
            border-radius: 12px;
        }
        .preview-snowpea {
            background: radial-gradient(circle at 40% 40%, #81d4fa, #0288d1);
            border-radius: 50%;
        }
        .preview-repeater {
            background: radial-gradient(circle at 40% 40%, #c62828, #7f0000);
            border-radius: 50%;
        }

        /* ===== GAME GRID ===== */
        #game-container {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(5, 1fr);
            border: 3px solid #555;
            background-color: #2d5016;
        }
        .cell {
            width: 60px;
            height: 60px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            position: relative;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .cell:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .cell.row-even {
            background: #4a9e2d;
            background-image:
                repeating-linear-gradient(90deg, rgba(255,255,255,0.04) 0px, rgba(255,255,255,0.04) 1px, transparent 1px, transparent 6px),
                linear-gradient(180deg, rgba(255,255,255,0.07) 0%, transparent 40%, rgba(0,0,0,0.07) 100%);
        }
        .cell.row-odd {
            background: #3d8621;
            background-image:
                repeating-linear-gradient(90deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 6px),
                linear-gradient(180deg, rgba(255,255,255,0.05) 0%, transparent 40%, rgba(0,0,0,0.05) 100%);
        }
        .cell.col-9 {
            background: linear-gradient(180deg, #5a3a20, #4a2e15) !important;
            background-image:
                repeating-linear-gradient(90deg, rgba(0,0,0,0.06) 0px, rgba(0,0,0,0.06) 2px, transparent 2px, transparent 8px) !important;
        }

        /* ===== PLANT STYLES (in grid) ===== */
        .plant {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 50px;
            height: 50px;
            z-index: 5;
        }
        /* Peashooter - textured green head with stem, mouth tube, glossy eyes */
        .plant-peashooter {
            background:
                radial-gradient(circle at 30% 25%, rgba(255,255,255,0.35) 0%, transparent 30%),
                radial-gradient(circle at 55% 55%, #388e3c, #2e7d32 50%, #1b5e20);
            border-radius: 50%;
            box-shadow: inset -3px -4px 6px rgba(0,0,0,0.35), inset 2px 2px 4px rgba(255,255,255,0.15), 0 2px 3px rgba(0,0,0,0.3);
        }
        .plant-peashooter::before {
            content: '';
            position: absolute;
            width: 9px; height: 10px;
            background: radial-gradient(circle at 40% 35%, #fff, #ddd);
            border-radius: 50%;
            top: 10px; left: 8px;
            box-shadow:
                15px 0 0 0 #fff,
                3px 4px 0 0 #111,
                18px 4px 0 0 #111,
                2px 3px 0 0.5px #1b5e20,
                17px 3px 0 0.5px #1b5e20;
        }
        .plant-peashooter::after {
            content: '';
            position: absolute;
            width: 18px; height: 12px;
            background: linear-gradient(180deg, #2e7d32, #1b5e20);
            border-radius: 2px 10px 10px 2px;
            top: 19px; right: -5px;
            box-shadow: inset -2px 0 4px rgba(0,0,0,0.4), inset 6px 0 0 rgba(0,0,0,0.15);
        }

        /* Sunflower - petal ring around brown center, happy face, stem hint */
        .plant-sunflower {
            background:
                radial-gradient(circle at 50% 50%, #5d4037 30%, transparent 31%),
                radial-gradient(circle at 30% 25%, rgba(255,255,255,0.3) 0%, transparent 25%),
                radial-gradient(circle at 50% 50%, #ffee58, #f9a825 55%, #e65100);
            border-radius: 50%;
            box-shadow:
                0 -8px 0 -2px #fdd835, 0 8px 0 -2px #f9a825,
                -8px 0 0 -2px #fdd835, 8px 0 0 -2px #f9a825,
                -6px -6px 0 -3px #ffeb3b, 6px -6px 0 -3px #ffeb3b,
                -6px 6px 0 -3px #f9a825, 6px 6px 0 -3px #f9a825,
                inset -2px -2px 4px rgba(0,0,0,0.2), 0 2px 3px rgba(0,0,0,0.3);
        }
        .plant-sunflower::before {
            content: '';
            position: absolute;
            width: 6px; height: 7px;
            background: #1a1a1a;
            border-radius: 50%;
            top: 16px; left: 14px;
            box-shadow: 12px 0 0 #1a1a1a;
        }
        .plant-sunflower::after {
            content: '';
            position: absolute;
            width: 12px; height: 5px;
            border: 2px solid #3e2723;
            border-top: none;
            border-radius: 0 0 8px 8px;
            bottom: 14px; left: 17px;
            background: transparent;
        }

        /* Wall-nut - wood grain texture, detailed face, cracks when damaged */
        .plant-wallnut {
            background:
                repeating-linear-gradient(15deg, transparent, transparent 3px, rgba(0,0,0,0.05) 3px, rgba(0,0,0,0.05) 4px),
                radial-gradient(circle at 35% 30%, rgba(255,255,255,0.2) 0%, transparent 35%),
                radial-gradient(circle at 50% 50%, #bcaaa4, #8d6e63 50%, #5d4037);
            border-radius: 14px;
            box-shadow: inset -3px -4px 6px rgba(0,0,0,0.35), inset 2px 2px 3px rgba(255,255,255,0.12), 0 2px 3px rgba(0,0,0,0.3);
            transition: filter 0.3s, box-shadow 0.3s;
        }
        .plant-wallnut::before {
            content: '';
            position: absolute;
            width: 7px; height: 11px;
            background: #3e2723;
            border-radius: 50%;
            top: 12px; left: 11px;
            box-shadow: 15px 0 0 #3e2723,
                2px 3px 0 0 rgba(255,255,255,0.15),
                17px 3px 0 0 rgba(255,255,255,0.15);
        }
        .plant-wallnut::after {
            content: '';
            position: absolute;
            width: 18px; height: 5px;
            background: #3e2723;
            border-radius: 3px;
            bottom: 10px; left: 16px;
            box-shadow: 0 -2px 0 rgba(0,0,0,0.1);
        }
        .plant-wallnut.wallnut-damaged {
            background:
                repeating-linear-gradient(15deg, transparent, transparent 3px, rgba(0,0,0,0.08) 3px, rgba(0,0,0,0.08) 4px),
                radial-gradient(circle at 50% 50%, #8d6e63, #6d4c41 50%, #4e342e);
            box-shadow: inset 0 0 6px rgba(0,0,0,0.5), inset 4px 0 0 rgba(80,40,20,0.3), 0 2px 3px rgba(0,0,0,0.3);
        }
        .plant-wallnut.wallnut-damaged::before {
            box-shadow: 15px 0 0 #3e2723, 8px 10px 0 1px rgba(0,0,0,0.25);
        }
        .plant-wallnut.wallnut-critical {
            background:
                repeating-linear-gradient(45deg, transparent 0px, transparent 2px, rgba(0,0,0,0.12) 2px, rgba(0,0,0,0.12) 3px),
                radial-gradient(circle at 50% 50%, #795548, #5d4037 50%, #3e2723);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.7), inset 5px 3px 0 rgba(0,0,0,0.2), inset -5px 5px 0 rgba(0,0,0,0.2);
            filter: brightness(0.75);
        }
        .plant-wallnut.wallnut-critical::before {
            box-shadow: 15px 0 0 #3e2723, 5px 7px 0 1px rgba(0,0,0,0.35), 20px 10px 0 1px rgba(0,0,0,0.25);
        }

        /* Snow Pea - icy blue head with frost highlights */
        .plant-snowpea {
            background:
                radial-gradient(circle at 28% 22%, rgba(255,255,255,0.5) 0%, transparent 28%),
                radial-gradient(circle at 55% 55%, #4fc3f7, #0288d1 50%, #01579b);
            border-radius: 50%;
            box-shadow: inset -3px -4px 6px rgba(0,0,0,0.3), inset 2px 2px 5px rgba(255,255,255,0.3), 0 0 6px rgba(129,212,250,0.4), 0 2px 3px rgba(0,0,0,0.3);
        }
        .plant-snowpea::before {
            content: '';
            position: absolute;
            width: 9px; height: 10px;
            background: radial-gradient(circle at 40% 35%, #e0f7fa, #b3e5fc);
            border-radius: 50%;
            top: 10px; left: 8px;
            box-shadow:
                15px 0 0 0 #e0f7fa,
                3px 4px 0 0 #0d47a1,
                18px 4px 0 0 #0d47a1;
        }
        .plant-snowpea::after {
            content: '';
            position: absolute;
            width: 18px; height: 12px;
            background: linear-gradient(180deg, #0288d1, #01579b);
            border-radius: 2px 10px 10px 2px;
            top: 19px; right: -5px;
            box-shadow: inset -2px 0 4px rgba(0,0,0,0.3), 0 0 4px rgba(129,212,250,0.3);
        }

        /* Repeater - dark red double-barrel shooter */
        .plant-repeater {
            background:
                radial-gradient(circle at 30% 25%, rgba(255,255,255,0.25) 0%, transparent 25%),
                radial-gradient(circle at 55% 55%, #ef5350, #c62828 50%, #7f0000);
            border-radius: 50%;
            box-shadow: inset -3px -4px 6px rgba(0,0,0,0.4), inset 2px 2px 4px rgba(255,255,255,0.15), 0 2px 3px rgba(0,0,0,0.3);
        }
        .plant-repeater::before {
            content: '';
            position: absolute;
            width: 9px; height: 10px;
            background: radial-gradient(circle at 40% 35%, #fff, #ffcdd2);
            border-radius: 50%;
            top: 10px; left: 8px;
            box-shadow:
                15px 0 0 0 #fff,
                3px 4px 0 0 #111,
                18px 4px 0 0 #111;
        }
        .plant-repeater::after {
            content: '';
            position: absolute;
            width: 22px; height: 14px;
            background: linear-gradient(180deg, #b71c1c 40%, #7f0000);
            border-radius: 2px 10px 10px 2px;
            top: 17px; right: -8px;
            box-shadow: inset -2px 0 5px rgba(0,0,0,0.5), inset 0 -3px 0 rgba(0,0,0,0.15), inset 0 3px 0 rgba(255,255,255,0.1);
        }

        /* ===== ZOMBIE ===== */
        .zombie {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 50px;
            height: 50px;
            background:
                radial-gradient(circle at 32% 28%, rgba(120,180,100,0.35) 0%, transparent 30%),
                radial-gradient(circle at 70% 65%, rgba(0,0,0,0.2) 0%, transparent 35%),
                repeating-linear-gradient(170deg, transparent, transparent 4px, rgba(0,0,0,0.06) 4px, rgba(0,0,0,0.06) 5px),
                radial-gradient(circle at 50% 50%, #6a8f5c, #4a6d3c 45%, #2d4a22);
            border-radius: 10px 10px 6px 6px;
            box-shadow: inset -3px -4px 6px rgba(0,0,0,0.4), inset 2px 2px 4px rgba(140,200,120,0.2), 0 3px 5px rgba(0,0,0,0.4);
            z-index: 6;
        }
        .zombie::before {
            content: '';
            position: absolute;
            width: 11px; height: 12px;
            background: radial-gradient(circle at 40% 35%, #ff1744, #b71c1c);
            border-radius: 50%;
            top: 10px; left: 7px;
            box-shadow:
                19px 0 0 0 #ff1744,
                2px 3px 0 0 #1a0000,
                21px 3px 0 0 #1a0000,
                0 0 4px rgba(255,23,68,0.5),
                19px 0 4px rgba(255,23,68,0.5);
        }
        .zombie::after {
            content: '';
            position: absolute;
            width: 28px; height: 8px;
            background:
                linear-gradient(180deg, #5d4037 0%, #3e2723 100%);
            border-radius: 2px 2px 4px 4px;
            bottom: 10px; left: 11px;
            box-shadow:
                inset 0 -2px 3px rgba(0,0,0,0.4),
                -3px 3px 0 -1px #4a6d3c,
                25px 3px 0 -1px #4a6d3c,
                -3px 7px 0 -1px #3e2723,
                25px 7px 0 -1px #3e2723;
        }
        .zombie.slowed {
            box-shadow: inset -3px -4px 6px rgba(0,0,0,0.4), inset 2px 2px 4px rgba(129,212,250,0.4), 0 0 10px rgba(129,212,250,0.6), 0 0 20px rgba(129,212,250,0.3);
            filter: brightness(0.85) saturate(0.6) hue-rotate(180deg);
        }

        /* ===== SUN PROGRESS BAR ===== */
        .sun-progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(0,0,0,0.3);
            border-radius: 0 0 2px 2px;
            overflow: hidden;
            z-index: 5;
        }
        .sun-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ffeb3b, #ff9800);
            border-radius: 0 0 2px 2px;
            transition: width 0.25s linear;
        }

        /* ===== PROJECTILE ===== */
        .projectile {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 7;
        }
        .proj-normal {
            background:
                radial-gradient(circle at 35% 30%, rgba(255,255,255,0.5) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, #81c784, #43a047 40%, #1b5e20);
            box-shadow: 0 0 6px rgba(102,187,106,0.7), 0 0 12px rgba(76,175,80,0.3), inset -1px -1px 2px rgba(0,0,0,0.3);
        }
        .proj-ice {
            background:
                radial-gradient(circle at 30% 25%, rgba(255,255,255,0.7) 0%, transparent 45%),
                radial-gradient(circle at 50% 50%, #b3e5fc, #29b6f6 40%, #0277bd);
            box-shadow: 0 0 6px rgba(129,212,250,0.8), 0 0 14px rgba(3,169,244,0.4), inset -1px -1px 2px rgba(0,0,0,0.2);
        }
        .proj-fire {
            background:
                radial-gradient(circle at 35% 30%, rgba(255,255,200,0.6) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, #ff8a65, #f44336 40%, #b71c1c);
            box-shadow: 0 0 6px rgba(239,83,80,0.8), 0 0 14px rgba(244,67,54,0.4), inset -1px -1px 2px rgba(0,0,0,0.3);
        }

        /* ===== SUN DROP ===== */
        .sun-drop {
            position: absolute;
            width: 26px;
            height: 26px;
            background:
                radial-gradient(circle at 35% 30%, rgba(255,255,255,0.6) 0%, transparent 35%),
                radial-gradient(circle at 50% 50%, #fff176, #ffee58 30%, #fbc02d 60%, #f57f17);
            border-radius: 50%;
            z-index: 8;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow:
                0 0 8px rgba(255,235,59,0.8),
                0 0 16px rgba(255,193,7,0.4),
                0 0 24px rgba(255,152,0,0.2),
                inset -2px -2px 4px rgba(245,127,23,0.3);
            animation: sun-pulse 0.8s infinite alternate;
        }
        .sun-drop::before {
            content: '';
            position: absolute;
            top: -4px; left: -4px;
            right: -4px; bottom: -4px;
            background:
                conic-gradient(from 0deg, transparent 0deg, rgba(255,235,59,0.3) 10deg, transparent 20deg,
                    transparent 45deg, rgba(255,235,59,0.3) 55deg, transparent 65deg,
                    transparent 90deg, rgba(255,235,59,0.3) 100deg, transparent 110deg,
                    transparent 135deg, rgba(255,235,59,0.3) 145deg, transparent 155deg,
                    transparent 180deg, rgba(255,235,59,0.3) 190deg, transparent 200deg,
                    transparent 225deg, rgba(255,235,59,0.3) 235deg, transparent 245deg,
                    transparent 270deg, rgba(255,235,59,0.3) 280deg, transparent 290deg,
                    transparent 315deg, rgba(255,235,59,0.3) 325deg, transparent 335deg);
            border-radius: 50%;
        }
        @keyframes sun-pulse {
            0% { box-shadow: 0 0 6px rgba(255,235,59,0.8), 0 0 12px rgba(255,193,7,0.3), inset -2px -2px 4px rgba(245,127,23,0.3); transform: translate(-50%, -50%) scale(1); }
            100% { box-shadow: 0 0 10px rgba(255,235,59,0.9), 0 0 20px rgba(255,193,7,0.5), 0 0 30px rgba(255,152,0,0.2), inset -2px -2px 4px rgba(245,127,23,0.3); transform: translate(-50%, -50%) scale(1.12); }
        }

        /* ===== OVERLAY ===== */
        #message-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 200;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #message-overlay.active { display: flex; }
        #message-text {
            font-size: 48px;
            font-weight: bold;
            text-shadow: 2px 2px 4px #000;
            margin-bottom: 20px;
        }
        #message-sub {
            font-size: 20px;
            color: #ccc;
            margin-bottom: 30px;
        }
        #retry-btn {
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: #fff;
            transition: transform 0.2s;
        }
        #retry-btn:hover { transform: scale(1.05); }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 780px) {
            #plant-panel { width: 60px; }
            .plant-option .plant-preview { width: 32px; height: 32px; }
            .plant-option .plant-name { font-size: 8px; }
            .plant-option .plant-cost { font-size: 9px; }
            #sun-icon { font-size: 18px; }
            #sun-count { font-size: 13px; }
            .cell { width: 36px; height: 36px; }
            .plant {
                top: 3px; left: 3px;
                width: 30px; height: 30px;
            }
            /* Peashooter / Snow Pea / Repeater eyes */
            .plant-peashooter::before, .plant-snowpea::before, .plant-repeater::before {
                width: 7px; height: 8px;
                top: 7px; left: 5px;
                box-shadow:
                    12px 0 0 0 inherit,
                    2px 3px 0 0 #111,
                    14px 3px 0 0 #111;
            }
            /* Peashooter / Snow Pea mouth tube */
            .plant-peashooter::after, .plant-snowpea::after {
                width: 12px; height: 8px;
                top: 14px; right: -3px;
            }
            /* Repeater double-barrel */
            .plant-repeater::after {
                width: 16px; height: 10px;
                top: 13px; right: -5px;
            }
            /* Sunflower petals + face */
            .plant-sunflower::before {
                width: 5px; height: 5px;
                top: 9px; left: 6px;
                box-shadow: 9px 0 0 #5d4037;
            }
            .plant-sunflower::after {
                width: 10px; height: 5px;
                bottom: 7px; left: 8px;
            }
            /* Wall-nut face */
            .plant-wallnut::before {
                width: 5px; height: 8px;
                top: 7px; left: 6px;
                box-shadow: 10px 0 0 #3e2723;
            }
            .plant-wallnut::after {
                width: 12px; height: 4px;
                bottom: 6px; left: 9px;
            }
            /* Zombie */
            .zombie {
                top: 3px; left: 3px;
                width: 30px; height: 30px;
            }
            .zombie::before {
                width: 7px; height: 8px;
                top: 6px; left: 4px;
                box-shadow:
                    12px 0 0 0 #ff1744,
                    2px 2px 0 0 #1a0000,
                    14px 2px 0 0 #1a0000,
                    0 0 3px rgba(255,23,68,0.5),
                    12px 0 3px rgba(255,23,68,0.5);
            }
            .zombie::after {
                width: 17px; height: 5px;
                bottom: 6px; left: 7px;
                box-shadow:
                    inset 0 -1px 2px rgba(0,0,0,0.4),
                    -2px 2px 0 -1px #4a6d3c,
                    15px 2px 0 -1px #4a6d3c,
                    -2px 4px 0 -1px #3e2723,
                    15px 4px 0 -1px #3e2723;
            }
            .projectile { width: 10px; height: 10px; }
            .sun-drop { width: 20px; height: 20px; }
            .sun-drop::before { top: -3px; left: -3px; right: -3px; bottom: -3px; }
            h1 { font-size: 22px; }
            #status-bar { font-size: 13px; gap: 15px; }
            #message-text { font-size: 32px; }
            #message-sub { font-size: 16px; }
        }
        @media (max-width: 480px) {
            #plant-panel { width: 48px; }
            .plant-option { padding: 4px 2px; }
            .plant-option .plant-preview { width: 26px; height: 26px; }
            .plant-option .plant-name { font-size: 7px; }
            .plant-option .plant-cost { font-size: 8px; }
            #sun-icon { font-size: 14px; }
            #sun-count { font-size: 11px; }
            #sun-display { padding: 5px 2px; }
            .cell { width: 28px; height: 28px; }
            .plant {
                top: 2px; left: 2px;
                width: 24px; height: 24px;
            }
            .plant-peashooter::before, .plant-snowpea::before, .plant-repeater::before {
                width: 5px; height: 6px;
                top: 5px; left: 3px;
                box-shadow:
                    10px 0 0 0 inherit,
                    1px 2px 0 0 #111,
                    11px 2px 0 0 #111;
            }
            .plant-peashooter::after, .plant-snowpea::after {
                width: 9px; height: 6px;
                top: 11px; right: -2px;
            }
            .plant-repeater::after {
                width: 12px; height: 7px;
                top: 10px; right: -4px;
            }
            .plant-sunflower::before {
                width: 4px; height: 4px;
                top: 7px; left: 5px;
                box-shadow: 7px 0 0 #5d4037;
            }
            .plant-sunflower::after {
                width: 8px; height: 4px;
                bottom: 5px; left: 6px;
            }
            .plant-wallnut::before {
                width: 4px; height: 6px;
                top: 5px; left: 5px;
                box-shadow: 8px 0 0 #3e2723;
            }
            .plant-wallnut::after {
                width: 10px; height: 3px;
                bottom: 5px; left: 7px;
            }
            .zombie {
                top: 2px; left: 2px;
                width: 24px; height: 24px;
            }
            .zombie::before {
                width: 6px; height: 6px;
                top: 4px; left: 3px;
                box-shadow:
                    9px 0 0 0 #ff1744,
                    1px 2px 0 0 #1a0000,
                    10px 2px 0 0 #1a0000;
            }
            .zombie::after {
                width: 14px; height: 4px;
                bottom: 4px; left: 5px;
                box-shadow:
                    inset 0 -1px 1px rgba(0,0,0,0.4),
                    -2px 2px 0 -1px #4a6d3c,
                    12px 2px 0 -1px #4a6d3c;
            }
            .projectile { width: 8px; height: 8px; }
            .sun-drop { width: 16px; height: 16px; }
            .sun-drop::before { top: -2px; left: -2px; right: -2px; bottom: -2px; }
            h1 { font-size: 18px; }
            #status-bar { font-size: 11px; gap: 10px; }
        }
    </style>
</head>
<body>
    <div id="top-bar">
        <div id="user-info">
            <span id="guest-notice">Playing as Guest - <a href="/games/01/login.html" style="color: #e94560;">Login to save</a></span>
            <span id="logged-user" style="display: none;">
                Welcome, <span class="username" id="display-name"></span>
                <span class="coins" id="display-coins"></span>
            </span>
        </div>
        <div class="nav-links">
            <a href="/games/01/home.html">Home</a>
            <a id="auth-link" href="/games/01/login.html">Login</a>
        </div>
    </div>

    <div id="game-wrapper">
        <h1>Plant Defense</h1>
        <div id="status-bar">
            <span class="wave-info">Wave: <span id="wave-count">1</span></span>
            <span class="kills-info">Kills: <span id="kills-count">0</span></span>
        </div>
        <div id="game-area">
            <div id="plant-panel">
                <div id="sun-display">
                    <span id="sun-icon">&#9728;</span>
                    <span id="sun-count">100</span>
                </div>
                <!-- Plant options populated by JS -->
            </div>
            <div id="game-container"></div>
        </div>
    </div>

    <div id="message-overlay">
        <div id="message-text"></div>
        <div id="message-sub"></div>
        <button id="retry-btn" onclick="restartGame()">Play Again</button>
    </div>

    <script>
        // ========== AUTH ==========
        const API_URL = '/games/01/api';

        function initUserDisplay() {
            const userStr = localStorage.getItem('user');
            const authLink = document.getElementById('auth-link');
            const guestNotice = document.getElementById('guest-notice');
            const loggedUser = document.getElementById('logged-user');

            if (userStr) {
                const user = JSON.parse(userStr);
                guestNotice.style.display = 'none';
                loggedUser.style.display = 'inline';
                document.getElementById('display-name').textContent = user.name;
                document.getElementById('display-coins').textContent = `Coins: ${user.coins || 0}`;
                authLink.textContent = 'Logout';
                authLink.href = '#';
                authLink.onclick = handleLogout;
            } else {
                guestNotice.style.display = 'inline';
                loggedUser.style.display = 'none';
                authLink.textContent = 'Login';
                authLink.href = '/games/01/login.html';
                authLink.onclick = null;
            }
        }

        function handleLogout(e) {
            e.preventDefault();
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            initUserDisplay();
        }

        // ========== PLANT TYPES ==========
        const PLANT_TYPES = [
            {
                id: 'peashooter',
                name: 'Peashooter',
                cost: 100,
                hp: 1,
                shootInterval: 3000,
                damage: 1,
                projectileClass: 'proj-normal',
                previewClass: 'preview-peashooter',
                plantClass: 'plant-peashooter',
                special: null
            },
            {
                id: 'sunflower',
                name: 'Sunflower',
                cost: 50,
                hp: 1,
                shootInterval: null, // doesn't shoot
                damage: 0,
                projectileClass: null,
                previewClass: 'preview-sunflower',
                plantClass: 'plant-sunflower',
                special: 'sun_producer' // produces 25 suns every 10s
            },
            {
                id: 'wallnut',
                name: 'Wall-nut',
                cost: 50,
                hp: 15,
                shootInterval: null, // doesn't shoot
                damage: 0,
                projectileClass: null,
                previewClass: 'preview-wallnut',
                plantClass: 'plant-wallnut',
                special: 'wall' // blocks zombies, 15s durability, eaten faster by more zombies
            },
            {
                id: 'snowpea',
                name: 'Snow Pea',
                cost: 175,
                hp: 1,
                shootInterval: 3000,
                damage: 1,
                projectileClass: 'proj-ice',
                previewClass: 'preview-snowpea',
                plantClass: 'plant-snowpea',
                special: 'slow' // slows zombies
            },
            {
                id: 'repeater',
                name: 'Repeater',
                cost: 200,
                hp: 1,
                shootInterval: 3000,
                damage: 1,
                projectileClass: 'proj-fire',
                previewClass: 'preview-repeater',
                plantClass: 'plant-repeater',
                special: 'double_shot' // shoots twice per interval
            }
        ];

        // ========== GAME STATE ==========
        const ROWS = 5;
        const COLS = 10;
        const ZOMBIE_MOVE_INTERVAL = 6000; // 10 cols * 6s = 60s to cross
        const ZOMBIE_SLOW_MOVE_INTERVAL = 12000; // slowed zombies
        const PROJECTILE_MOVE_INTERVAL = 400;
        const ZOMBIE_SPAWN_INTERVAL = 5000;
        const SUN_PRODUCE_INTERVAL = 15000;

        let gameOver = false;
        let suns = 100;
        let selectedPlantType = null; // index into PLANT_TYPES
        let plants = []; // { row, col, element, type, hp, shootInterval, sunInterval }
        let zombies = []; // { row, col, element, hp, slowed, slowTimer, moveCounter }
        let projectiles = []; // { row, col, element, damage, special }
        let kills = 0;
        let wave = 1;
        let zombiesSpawned = 0;
        let zombiesPerWave = 5;

        let zombieMoveTimer = null;
        let projectileMoveTimer = null;
        let zombieSpawnTimer = null;
        let wallnutDamageTimer = null;

        const grid = [];
        const container = document.getElementById('game-container');
        const plantPanel = document.getElementById('plant-panel');

        // ========== PLANT PANEL ==========
        function buildPlantPanel() {
            // Remove existing options (keep sun display)
            plantPanel.querySelectorAll('.plant-option').forEach(el => el.remove());

            for (let i = 0; i < PLANT_TYPES.length; i++) {
                const type = PLANT_TYPES[i];
                const option = document.createElement('div');
                option.className = 'plant-option';
                option.dataset.index = i;
                option.innerHTML = `
                    <div class="plant-preview ${type.previewClass}"></div>
                    <div class="plant-name">${type.name}</div>
                    <div class="plant-cost">${type.cost}</div>
                `;
                option.addEventListener('click', () => selectPlantType(i));
                plantPanel.appendChild(option);
            }
            updatePlantPanel();
        }

        function selectPlantType(index) {
            if (gameOver) return;
            const type = PLANT_TYPES[index];
            if (suns < type.cost) return;

            if (selectedPlantType === index) {
                selectedPlantType = null; // deselect
            } else {
                selectedPlantType = index;
            }
            updatePlantPanel();
        }

        function updatePlantPanel() {
            document.getElementById('sun-count').textContent = suns;
            const options = plantPanel.querySelectorAll('.plant-option');
            options.forEach(option => {
                const idx = parseInt(option.dataset.index);
                const type = PLANT_TYPES[idx];
                option.classList.toggle('selected', selectedPlantType === idx);
                option.classList.toggle('disabled', suns < type.cost);
            });
        }

        // ========== GRID SETUP ==========
        function buildGrid() {
            container.innerHTML = '';
            grid.length = 0;

            for (let r = 0; r < ROWS; r++) {
                grid[r] = [];
                for (let c = 0; c < COLS; c++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${r % 2 === 0 ? 'row-even' : 'row-odd'} col-${c}`;
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.addEventListener('click', () => handleCellClick(r, c));
                    container.appendChild(cell);
                    grid[r][c] = cell;
                }
            }
        }

        // ========== PLANT LOGIC ==========
        function handleCellClick(row, col) {
            if (gameOver) return;
            if (selectedPlantType === null) return;
            if (col >= COLS - 1) return; // Can't plant on last column

            const type = PLANT_TYPES[selectedPlantType];
            if (suns < type.cost) return;

            // Check if cell already has a plant
            if (plants.some(p => p.row === row && p.col === col)) return;

            // Check if cell has a zombie
            if (zombies.some(z => z.row === row && z.col === col)) return;

            placePlant(row, col, type);
            suns -= type.cost;
            selectedPlantType = null; // deselect after planting
            updatePlantPanel();
        }

        function placePlant(row, col, type) {
            const plantEl = document.createElement('div');
            plantEl.className = `plant ${type.plantClass}`;
            grid[row][col].appendChild(plantEl);

            const plant = {
                row, col, element: plantEl,
                type: type,
                hp: type.hp,
                maxHp: type.hp,
                shootInterval: null,
                sunInterval: null
            };

            // Set up shooting for shooter plants
            if (type.shootInterval) {
                plant.shootInterval = setInterval(() => {
                    if (gameOver) return;
                    shootProjectile(row, col, type);
                }, type.shootInterval);
            }

            // Set up sun production for sunflowers
            if (type.special === 'sun_producer') {
                setupSunProgress(plant);
                plant.sunInterval = setInterval(() => {
                    if (gameOver) return;
                    autoGenerateSun(plant);
                }, SUN_PRODUCE_INTERVAL);
            }

            plants.push(plant);
        }

        function removePlant(plant) {
            if (plant.shootInterval) clearInterval(plant.shootInterval);
            if (plant.sunInterval) clearInterval(plant.sunInterval);
            if (plant.sunProgressRAF) cancelAnimationFrame(plant.sunProgressRAF);
            plant.element.remove();
            plants = plants.filter(p => p !== plant);
        }

        // ========== SUN LOGIC ==========
        let sunProgressTimers = []; // track animation frames for cleanup

        function setupSunProgress(plant) {
            // Add progress bar to plant element
            const bar = document.createElement('div');
            bar.className = 'sun-progress-bar';
            const fill = document.createElement('div');
            fill.className = 'sun-progress-fill';
            bar.appendChild(fill);
            plant.element.appendChild(bar);
            plant.sunFill = fill;
            plant.sunStart = performance.now();

            // Animate progress bar
            function updateBar() {
                if (gameOver || !plant.element.parentNode) return;
                const elapsed = performance.now() - plant.sunStart;
                const pct = Math.min(100, (elapsed / SUN_PRODUCE_INTERVAL) * 100);
                fill.style.width = pct + '%';
                if (pct < 100) {
                    plant.sunProgressRAF = requestAnimationFrame(updateBar);
                }
            }
            plant.sunProgressRAF = requestAnimationFrame(updateBar);
        }

        function autoGenerateSun(plant) {
            if (gameOver) return;
            suns += 25;
            updatePlantPanel();
            // Flash the plant briefly to indicate sun generated
            plant.element.style.filter = 'brightness(1.5)';
            setTimeout(() => {
                if (plant.element.parentNode) plant.element.style.filter = '';
            }, 300);
            // Reset progress bar
            plant.sunStart = performance.now();
            if (plant.sunFill) plant.sunFill.style.width = '0%';
        }

        // ========== PROJECTILE LOGIC ==========
        function shootProjectile(fromRow, fromCol, type) {
            // Only shoot if there's a zombie in the same row to the right
            const hasTarget = zombies.some(z => z.row === fromRow && z.col > fromCol);
            if (!hasTarget) return;

            createProjectile(fromRow, fromCol, type);

            // Double shot for repeater
            if (type.special === 'double_shot') {
                setTimeout(() => {
                    if (!gameOver) createProjectile(fromRow, fromCol, type);
                }, 200);
            }
        }

        function createProjectile(fromRow, fromCol, type) {
            const projEl = document.createElement('div');
            projEl.className = `projectile ${type.projectileClass}`;
            grid[fromRow][fromCol].appendChild(projEl);

            projectiles.push({
                row: fromRow, col: fromCol,
                element: projEl,
                damage: type.damage,
                special: type.special
            });
        }

        function moveProjectiles() {
            if (gameOver) return;

            const toRemove = [];

            for (const proj of projectiles) {
                proj.element.remove();
                proj.col += 1;

                if (proj.col >= COLS) {
                    toRemove.push(proj);
                    continue;
                }

                // Check zombie collision
                const hitZombie = zombies.find(z => z.row === proj.row && z.col === proj.col);
                if (hitZombie) {
                    hitZombie.hp -= proj.damage;
                    toRemove.push(proj);

                    // Apply slow effect from snow pea
                    if (proj.special === 'slow' && !hitZombie.slowed) {
                        hitZombie.slowed = true;
                        hitZombie.element.classList.add('slowed');
                        // Slow lasts 4 seconds
                        if (hitZombie.slowTimer) clearTimeout(hitZombie.slowTimer);
                        hitZombie.slowTimer = setTimeout(() => {
                            hitZombie.slowed = false;
                            hitZombie.element.classList.remove('slowed');
                        }, 4000);
                    }

                    if (hitZombie.hp <= 0) {
                        killZombie(hitZombie);
                    }
                    continue;
                }

                grid[proj.row][proj.col].appendChild(proj.element);
            }

            for (const p of toRemove) {
                p.element.remove();
                projectiles = projectiles.filter(x => x !== p);
            }
        }

        // ========== ZOMBIE LOGIC ==========
        function spawnZombie() {
            if (gameOver) return;

            if (zombiesSpawned >= zombiesPerWave) {
                if (zombies.length === 0) nextWave();
                return;
            }

            const row = Math.floor(Math.random() * ROWS);
            const zombieEl = document.createElement('div');
            zombieEl.className = 'zombie';
            grid[row][COLS - 1].appendChild(zombieEl);

            // HP scales with wave
            const hp = 1 + Math.floor((wave - 1) / 2);

            zombies.push({
                row, col: COLS - 1, element: zombieEl,
                hp: hp,
                slowed: false, slowTimer: null,
                moveCounter: 0
            });
            zombiesSpawned++;
        }

        function moveZombies() {
            if (gameOver) return;

            for (const zombie of [...zombies]) {
                // Slowed zombies move every other tick
                if (zombie.slowed) {
                    zombie.moveCounter++;
                    if (zombie.moveCounter % 2 !== 0) continue; // skip this tick
                }

                // Check if zombie is held by a wall-nut on its current cell
                const wallnutHere = plants.find(p => p.row === zombie.row && p.col === zombie.col && p.type.id === 'wallnut');
                if (wallnutHere) continue; // Blocked â€” wall-nut damage handled by timer

                zombie.element.remove();
                zombie.col -= 1;

                // Reached left edge
                if (zombie.col < 0) {
                    triggerLose();
                    return;
                }

                // Check plant collision
                const hitPlant = plants.find(p => p.row === zombie.row && p.col === zombie.col);
                if (hitPlant) {
                    if (hitPlant.type.id !== 'wallnut') {
                        // Normal plant: deal damage
                        hitPlant.hp -= 1;
                        if (hitPlant.hp <= 0) {
                            removePlant(hitPlant);
                        }
                    }
                    // Wall-nut: zombie enters the cell and stops (damage handled by timer)
                }

                grid[zombie.row][zombie.col].appendChild(zombie.element);
            }
        }

        function killZombie(zombie) {
            if (zombie.slowTimer) clearTimeout(zombie.slowTimer);
            zombie.element.remove();
            zombies = zombies.filter(z => z !== zombie);
            kills++;
            updateStatus();

            if (zombiesSpawned >= zombiesPerWave && zombies.length === 0) {
                nextWave();
            }
        }

        // ========== WALL-NUT DURABILITY ==========
        function updateWallnutDamage() {
            if (gameOver) return;
            for (const plant of [...plants]) {
                if (plant.type.id !== 'wallnut') continue;
                const eatingCount = zombies.filter(z => z.row === plant.row && z.col === plant.col).length;
                if (eatingCount > 0) {
                    plant.hp -= eatingCount; // 1 per zombie per second
                    // Update visual
                    const pct = plant.hp / plant.maxHp;
                    if (pct < 0.33) {
                        plant.element.classList.add('wallnut-critical');
                        plant.element.classList.remove('wallnut-damaged');
                    } else if (pct < 0.66) {
                        plant.element.classList.add('wallnut-damaged');
                        plant.element.classList.remove('wallnut-critical');
                    }
                    if (plant.hp <= 0) {
                        removePlant(plant);
                    }
                }
            }
        }

        // ========== WAVES ==========
        function nextWave() {
            wave++;
            zombiesSpawned = 0;
            zombiesPerWave = 5 + (wave - 1) * 2;

            // Bonus suns each wave
            suns += 25;
            updatePlantPanel();
            updateStatus();

            clearInterval(zombieSpawnTimer);
            const spawnDelay = Math.max(1500, ZOMBIE_SPAWN_INTERVAL - (wave - 1) * 300);
            zombieSpawnTimer = setInterval(spawnZombie, spawnDelay);
        }

        // ========== GAME FLOW ==========
        function updateStatus() {
            document.getElementById('wave-count').textContent = wave;
            document.getElementById('kills-count').textContent = kills;
        }

        function triggerLose() {
            gameOver = true;
            clearAllTimers();

            const msgText = document.getElementById('message-text');
            const msgSub = document.getElementById('message-sub');
            msgText.style.color = '#e94560';
            msgText.textContent = 'Game Over!';
            msgSub.textContent = `You survived ${wave > 1 ? wave - 1 + ' waves' : 'wave 1'} and got ${kills} kills.`;
            document.getElementById('message-overlay').classList.add('active');
        }

        function clearAllTimers() {
            if (zombieMoveTimer) clearInterval(zombieMoveTimer);
            if (projectileMoveTimer) clearInterval(projectileMoveTimer);
            if (zombieSpawnTimer) clearInterval(zombieSpawnTimer);
            if (wallnutDamageTimer) clearInterval(wallnutDamageTimer);
            for (const plant of plants) {
                if (plant.shootInterval) clearInterval(plant.shootInterval);
                if (plant.sunInterval) clearInterval(plant.sunInterval);
                if (plant.sunProgressRAF) cancelAnimationFrame(plant.sunProgressRAF);
            }
            for (const zombie of zombies) {
                if (zombie.slowTimer) clearTimeout(zombie.slowTimer);
            }
        }

        function restartGame() {
            clearAllTimers();
            for (const p of plants) p.element.remove();
            for (const z of zombies) z.element.remove();
            for (const pr of projectiles) pr.element.remove();

            plants = [];
            zombies = [];
            projectiles = [];
            kills = 0;
            wave = 1;
            suns = 100;
            zombiesSpawned = 0;
            zombiesPerWave = 5;
            gameOver = false;
            selectedPlantType = null;

            document.getElementById('message-overlay').classList.remove('active');
            buildGrid();
            buildPlantPanel();
            updateStatus();
            startTimers();
        }

        function startTimers() {
            zombieMoveTimer = setInterval(moveZombies, ZOMBIE_MOVE_INTERVAL);
            projectileMoveTimer = setInterval(moveProjectiles, PROJECTILE_MOVE_INTERVAL);
            zombieSpawnTimer = setInterval(spawnZombie, ZOMBIE_SPAWN_INTERVAL);
            wallnutDamageTimer = setInterval(updateWallnutDamage, 1000);
            setTimeout(spawnZombie, 2000);
        }

        // ========== INIT ==========
        initUserDisplay();
        buildGrid();
        buildPlantPanel();
        updateStatus();
        startTimers();
    </script>
</body