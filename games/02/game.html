<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Defense</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: #1a1a2e;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 300;
        }
        #user-info {
            color: #fff;
            font-size: 14px;
        }
        #user-info .username { color: gold; font-weight: bold; }
        #user-info .coins { color: lime; margin-left: 15px; }
        .nav-links { display: flex; gap: 15px; }
        .nav-links a {
            color: #e94560;
            font-size: 14px;
            text-decoration: none;
            cursor: pointer;
        }
        .nav-links a:hover { color: #fff; text-decoration: underline; }

        #game-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 55px;
            gap: 10px;
        }
        h1 {
            color: gold;
            font-size: 28px;
            text-shadow: 2px 2px 4px #000;
        }
        #status-bar {
            display: flex;
            gap: 25px;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
        }
        #status-bar .wave-info { color: #ff9800; }
        #status-bar .kills-info { color: #e94560; }

        #game-area {
            display: flex;
            gap: 0;
        }

        /* ===== PLANT PANEL (left side) ===== */
        #plant-panel {
            display: flex;
            flex-direction: column;
            background-color: #16213e;
            border: 3px solid #555;
            border-right: none;
            width: 80px;
        }
        #sun-display {
            text-align: center;
            padding: 8px 4px;
            background-color: #1a1a2e;
            border-bottom: 2px solid #555;
        }
        #sun-icon {
            font-size: 24px;
            display: block;
        }
        #sun-count {
            color: #ffdd00;
            font-size: 16px;
            font-weight: bold;
        }
        .plant-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 4px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            transition: background-color 0.15s;
            position: relative;
        }
        .plant-option:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .plant-option.selected {
            background-color: rgba(76, 175, 80, 0.3);
            box-shadow: inset 0 0 0 2px #4CAF50;
        }
        .plant-option.disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }
        .plant-option .plant-preview {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            margin-bottom: 3px;
            position: relative;
        }
        .plant-option .plant-name {
            color: #ccc;
            font-size: 9px;
            text-align: center;
        }
        .plant-option .plant-cost {
            color: #ffdd00;
            font-size: 10px;
            font-weight: bold;
        }

        /* Plant preview shapes in panel */
        .preview-peashooter {
            background: radial-gradient(circle at 40% 40%, #66bb6a, #2e7d32);
            border-radius: 50%;
        }
        .preview-sunflower {
            background: radial-gradient(circle at 40% 40%, #ffee58, #f9a825);
            border-radius: 50%;
        }
        .preview-wallnut {
            background: radial-gradient(circle at 40% 40%, #a1887f, #6d4c41);
            border-radius: 12px;
        }
        .preview-snowpea {
            background: radial-gradient(circle at 40% 40%, #81d4fa, #0288d1);
            border-radius: 50%;
        }
        .preview-repeater {
            background: radial-gradient(circle at 40% 40%, #c62828, #7f0000);
            border-radius: 50%;
        }

        /* ===== GAME GRID ===== */
        #game-container {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(5, 1fr);
            border: 3px solid #555;
            background-color: #2d5016;
        }
        .cell {
            width: 60px;
            height: 60px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            position: relative;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .cell:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .cell.row-even { background-color: #336b1c; }
        .cell.row-odd { background-color: #2d5016; }
        .cell.col-9 { background-color: rgba(100, 0, 0, 0.3); }

        /* ===== PLANT STYLES (in grid) ===== */
        .plant {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 50px;
            height: 50px;
            z-index: 5;
        }
        /* Peashooter - green circle, black eyes */
        .plant-peashooter {
            background: radial-gradient(circle at 40% 40%, #66bb6a, #2e7d32);
            border-radius: 50%;
        }
        .plant-peashooter::before {
            content: '';
            position: absolute;
            width: 10px; height: 10px;
            background-color: #000;
            border-radius: 50%;
            top: 12px; left: 8px;
            box-shadow: 16px 0 0 #000;
        }
        .plant-peashooter::after {
            content: '';
            position: absolute;
            width: 16px; height: 10px;
            background-color: #1b5e20;
            border-radius: 0 8px 8px 0;
            top: 20px; right: -4px;
        }

        /* Sunflower - yellow circle, happy face, generates suns */
        .plant-sunflower {
            background: radial-gradient(circle at 40% 40%, #ffee58, #f9a825);
            border-radius: 50%;
        }
        .plant-sunflower::before {
            content: '';
            position: absolute;
            width: 8px; height: 8px;
            background-color: #5d4037;
            border-radius: 50%;
            top: 14px; left: 10px;
            box-shadow: 14px 0 0 #5d4037;
        }
        .plant-sunflower::after {
            content: '';
            position: absolute;
            width: 16px; height: 8px;
            border: 3px solid #5d4037;
            border-top: none;
            border-radius: 0 0 10px 10px;
            bottom: 12px; left: 14px;
            background: transparent;
        }

        /* Wall-nut - brown square, tough face */
        .plant-wallnut {
            background: radial-gradient(circle at 40% 40%, #a1887f, #6d4c41);
            border-radius: 12px;
            transition: filter 0.3s, box-shadow 0.3s;
        }
        .plant-wallnut::before {
            content: '';
            position: absolute;
            width: 8px; height: 12px;
            background-color: #3e2723;
            border-radius: 50%;
            top: 12px; left: 10px;
            box-shadow: 16px 0 0 #3e2723;
        }
        .plant-wallnut::after {
            content: '';
            position: absolute;
            width: 20px; height: 6px;
            background-color: #3e2723;
            border-radius: 3px;
            bottom: 10px; left: 15px;
        }
        .plant-wallnut.wallnut-damaged {
            background: radial-gradient(circle at 40% 40%, #8d6e63, #5d4037);
            box-shadow: inset 0 0 4px rgba(0,0,0,0.5);
        }
        .plant-wallnut.wallnut-damaged::before {
            box-shadow: 16px 0 0 #3e2723, 6px 8px 0 1px rgba(0,0,0,0.3);
        }
        .plant-wallnut.wallnut-critical {
            background: radial-gradient(circle at 40% 40%, #795548, #4e342e);
            box-shadow: inset 0 0 8px rgba(0,0,0,0.7);
            filter: brightness(0.7);
        }
        .plant-wallnut.wallnut-critical::before {
            box-shadow: 16px 0 0 #3e2723, 4px 6px 0 1px rgba(0,0,0,0.4), 20px 10px 0 1px rgba(0,0,0,0.3);
        }

        /* Snow Pea - blue circle, slows zombies */
        .plant-snowpea {
            background: radial-gradient(circle at 40% 40%, #81d4fa, #0288d1);
            border-radius: 50%;
        }
        .plant-snowpea::before {
            content: '';
            position: absolute;
            width: 10px; height: 10px;
            background-color: #01579b;
            border-radius: 50%;
            top: 12px; left: 8px;
            box-shadow: 16px 0 0 #01579b;
        }
        .plant-snowpea::after {
            content: '';
            position: absolute;
            width: 16px; height: 10px;
            background-color: #0277bd;
            border-radius: 0 8px 8px 0;
            top: 20px; right: -4px;
        }

        /* Repeater - red/dark circle, shoots twice */
        .plant-repeater {
            background: radial-gradient(circle at 40% 40%, #ef5350, #b71c1c);
            border-radius: 50%;
        }
        .plant-repeater::before {
            content: '';
            position: absolute;
            width: 10px; height: 10px;
            background-color: #000;
            border-radius: 50%;
            top: 12px; left: 8px;
            box-shadow: 16px 0 0 #000;
        }
        .plant-repeater::after {
            content: '';
            position: absolute;
            width: 20px; height: 10px;
            background-color: #7f0000;
            border-radius: 0 8px 8px 0;
            top: 18px; right: -8px;
        }

        /* ===== ZOMBIE ===== */
        .zombie {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 40% 40%, #8e44ad, #4a0e6b);
            border-radius: 8px;
            z-index: 6;
        }
        .zombie::before {
            content: '';
            position: absolute;
            width: 10px; height: 10px;
            background-color: #ff0000;
            border-radius: 50%;
            top: 12px; left: 8px;
            box-shadow: 18px 0 0 #ff0000;
        }
        .zombie::after {
            content: '';
            position: absolute;
            width: 24px; height: 6px;
            background-color: #ff0000;
            border-radius: 3px;
            bottom: 12px; left: 13px;
        }
        .zombie.slowed {
            opacity: 0.7;
            box-shadow: 0 0 8px #81d4fa;
        }

        /* ===== PROJECTILE ===== */
        .projectile {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 7;
        }
        .proj-normal {
            background: radial-gradient(circle, #66bb6a, #2e7d32);
            box-shadow: 0 0 6px #66bb6a;
        }
        .proj-ice {
            background: radial-gradient(circle, #81d4fa, #0288d1);
            box-shadow: 0 0 6px #81d4fa;
        }
        .proj-fire {
            background: radial-gradient(circle, #ef5350, #b71c1c);
            box-shadow: 0 0 6px #ef5350;
        }

        /* ===== SUN DROP ===== */
        .sun-drop {
            position: absolute;
            width: 24px;
            height: 24px;
            background: radial-gradient(circle at 40% 40%, #ffee58, #f9a825);
            border-radius: 50%;
            z-index: 8;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 0 10px #ffdd00;
            animation: sun-pulse 0.8s infinite alternate;
        }
        @keyframes sun-pulse {
            0% { box-shadow: 0 0 6px #ffdd00; transform: translate(-50%, -50%) scale(1); }
            100% { box-shadow: 0 0 14px #ffdd00; transform: translate(-50%, -50%) scale(1.1); }
        }

        /* ===== OVERLAY ===== */
        #message-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 200;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #message-overlay.active { display: flex; }
        #message-text {
            font-size: 48px;
            font-weight: bold;
            text-shadow: 2px 2px 4px #000;
            margin-bottom: 20px;
        }
        #message-sub {
            font-size: 20px;
            color: #ccc;
            margin-bottom: 30px;
        }
        #retry-btn {
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: #fff;
            transition: transform 0.2s;
        }
        #retry-btn:hover { transform: scale(1.05); }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 780px) {
            #plant-panel { width: 60px; }
            .plant-option .plant-preview { width: 32px; height: 32px; }
            .plant-option .plant-name { font-size: 8px; }
            .plant-option .plant-cost { font-size: 9px; }
            #sun-icon { font-size: 18px; }
            #sun-count { font-size: 13px; }
            .cell { width: 36px; height: 36px; }
            .plant {
                top: 3px; left: 3px;
                width: 30px; height: 30px;
            }
            .plant-peashooter::before, .plant-snowpea::before, .plant-repeater::before {
                width: 6px; height: 6px;
                top: 8px; left: 5px;
                box-shadow: 10px 0 0 inherit;
            }
            .plant-peashooter::after, .plant-snowpea::after {
                width: 10px; height: 6px;
                top: 12px; right: -2px;
            }
            .plant-repeater::after {
                width: 12px; height: 6px;
                top: 11px; right: -4px;
            }
            .plant-sunflower::before {
                width: 5px; height: 5px;
                top: 9px; left: 6px;
                box-shadow: 9px 0 0 #5d4037;
            }
            .plant-sunflower::after {
                width: 10px; height: 5px;
                border-width: 2px;
                bottom: 7px; left: 8px;
            }
            .plant-wallnut::before {
                width: 5px; height: 8px;
                top: 7px; left: 6px;
                box-shadow: 10px 0 0 #3e2723;
            }
            .plant-wallnut::after {
                width: 12px; height: 4px;
                bottom: 6px; left: 9px;
            }
            .zombie {
                top: 3px; left: 3px;
                width: 30px; height: 30px;
            }
            .zombie::before {
                width: 6px; height: 6px;
                top: 7px; left: 4px;
                box-shadow: 11px 0 0 #ff0000;
            }
            .zombie::after {
                width: 14px; height: 4px;
                bottom: 7px; left: 8px;
            }
            .projectile { width: 8px; height: 8px; }
            .sun-drop { width: 18px; height: 18px; }
            h1 { font-size: 22px; }
            #status-bar { font-size: 13px; gap: 15px; }
            #message-text { font-size: 32px; }
            #message-sub { font-size: 16px; }
        }
        @media (max-width: 480px) {
            #plant-panel { width: 48px; }
            .plant-option { padding: 4px 2px; }
            .plant-option .plant-preview { width: 26px; height: 26px; }
            .plant-option .plant-name { font-size: 7px; }
            .plant-option .plant-cost { font-size: 8px; }
            #sun-icon { font-size: 14px; }
            #sun-count { font-size: 11px; }
            #sun-display { padding: 5px 2px; }
            .cell { width: 28px; height: 28px; }
            .plant {
                top: 2px; left: 2px;
                width: 24px; height: 24px;
            }
            .plant-peashooter::before, .plant-snowpea::before, .plant-repeater::before {
                width: 5px; height: 5px;
                top: 6px; left: 4px;
                box-shadow: 8px 0 0 inherit;
            }
            .plant-peashooter::after, .plant-snowpea::after {
                width: 8px; height: 5px;
                top: 10px; right: -2px;
            }
            .plant-repeater::after {
                width: 10px; height: 5px;
                top: 9px; right: -3px;
            }
            .plant-sunflower::before {
                width: 4px; height: 4px;
                top: 7px; left: 5px;
                box-shadow: 7px 0 0 #5d4037;
            }
            .plant-sunflower::after {
                width: 8px; height: 4px;
                border-width: 2px;
                bottom: 5px; left: 6px;
            }
            .plant-wallnut::before {
                width: 4px; height: 6px;
                top: 5px; left: 5px;
                box-shadow: 8px 0 0 #3e2723;
            }
            .plant-wallnut::after {
                width: 10px; height: 3px;
                bottom: 5px; left: 7px;
            }
            .zombie {
                top: 2px; left: 2px;
                width: 24px; height: 24px;
            }
            .zombie::before {
                width: 5px; height: 5px;
                top: 5px; left: 3px;
                box-shadow: 9px 0 0 #ff0000;
            }
            .zombie::after {
                width: 12px; height: 3px;
                bottom: 5px; left: 6px;
            }
            .projectile { width: 6px; height: 6px; }
            .sun-drop { width: 14px; height: 14px; }
            h1 { font-size: 18px; }
            #status-bar { font-size: 11px; gap: 10px; }
        }
    </style>
</head>
<body>
    <div id="top-bar">
        <div id="user-info">
            <span id="guest-notice">Playing as Guest - <a href="/games/01/login.html" style="color: #e94560;">Login to save</a></span>
            <span id="logged-user" style="display: none;">
                Welcome, <span class="username" id="display-name"></span>
                <span class="coins" id="display-coins"></span>
            </span>
        </div>
        <div class="nav-links">
            <a href="/games/01/home.html">Home</a>
            <a id="auth-link" href="/games/01/login.html">Login</a>
        </div>
    </div>

    <div id="game-wrapper">
        <h1>Plant Defense</h1>
        <div id="status-bar">
            <span class="wave-info">Wave: <span id="wave-count">1</span></span>
            <span class="kills-info">Kills: <span id="kills-count">0</span></span>
        </div>
        <div id="game-area">
            <div id="plant-panel">
                <div id="sun-display">
                    <span id="sun-icon">&#9728;</span>
                    <span id="sun-count">50</span>
                </div>
                <!-- Plant options populated by JS -->
            </div>
            <div id="game-container"></div>
        </div>
    </div>

    <div id="message-overlay">
        <div id="message-text"></div>
        <div id="message-sub"></div>
        <button id="retry-btn" onclick="restartGame()">Play Again</button>
    </div>

    <script>
        // ========== AUTH ==========
        const API_URL = '/games/01/api';

        function initUserDisplay() {
            const userStr = localStorage.getItem('user');
            const authLink = document.getElementById('auth-link');
            const guestNotice = document.getElementById('guest-notice');
            const loggedUser = document.getElementById('logged-user');

            if (userStr) {
                const user = JSON.parse(userStr);
                guestNotice.style.display = 'none';
                loggedUser.style.display = 'inline';
                document.getElementById('display-name').textContent = user.name;
                document.getElementById('display-coins').textContent = `Coins: ${user.coins || 0}`;
                authLink.textContent = 'Logout';
                authLink.href = '#';
                authLink.onclick = handleLogout;
            } else {
                guestNotice.style.display = 'inline';
                loggedUser.style.display = 'none';
                authLink.textContent = 'Login';
                authLink.href = '/games/01/login.html';
                authLink.onclick = null;
            }
        }

        function handleLogout(e) {
            e.preventDefault();
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            initUserDisplay();
        }

        // ========== PLANT TYPES ==========
        const PLANT_TYPES = [
            {
                id: 'peashooter',
                name: 'Peashooter',
                cost: 100,
                hp: 1,
                shootInterval: 3000,
                damage: 1,
                projectileClass: 'proj-normal',
                previewClass: 'preview-peashooter',
                plantClass: 'plant-peashooter',
                special: null
            },
            {
                id: 'sunflower',
                name: 'Sunflower',
                cost: 50,
                hp: 1,
                shootInterval: null, // doesn't shoot
                damage: 0,
                projectileClass: null,
                previewClass: 'preview-sunflower',
                plantClass: 'plant-sunflower',
                special: 'sun_producer' // produces 25 suns every 10s
            },
            {
                id: 'wallnut',
                name: 'Wall-nut',
                cost: 50,
                hp: 15,
                shootInterval: null, // doesn't shoot
                damage: 0,
                projectileClass: null,
                previewClass: 'preview-wallnut',
                plantClass: 'plant-wallnut',
                special: 'wall' // blocks zombies, 15s durability, eaten faster by more zombies
            },
            {
                id: 'snowpea',
                name: 'Snow Pea',
                cost: 175,
                hp: 1,
                shootInterval: 3000,
                damage: 1,
                projectileClass: 'proj-ice',
                previewClass: 'preview-snowpea',
                plantClass: 'plant-snowpea',
                special: 'slow' // slows zombies
            },
            {
                id: 'repeater',
                name: 'Repeater',
                cost: 200,
                hp: 1,
                shootInterval: 3000,
                damage: 1,
                projectileClass: 'proj-fire',
                previewClass: 'preview-repeater',
                plantClass: 'plant-repeater',
                special: 'double_shot' // shoots twice per interval
            }
        ];

        // ========== GAME STATE ==========
        const ROWS = 5;
        const COLS = 10;
        const ZOMBIE_MOVE_INTERVAL = 4000;
        const ZOMBIE_SLOW_MOVE_INTERVAL = 6000; // slowed zombies
        const PROJECTILE_MOVE_INTERVAL = 400;
        const ZOMBIE_SPAWN_INTERVAL = 5000;
        const SUN_PRODUCE_INTERVAL = 10000;

        let gameOver = false;
        let suns = 50;
        let selectedPlantType = null; // index into PLANT_TYPES
        let plants = []; // { row, col, element, type, hp, shootInterval, sunInterval }
        let zombies = []; // { row, col, element, hp, slowed, slowTimer, moveCounter }
        let projectiles = []; // { row, col, element, damage, special }
        let kills = 0;
        let wave = 1;
        let zombiesSpawned = 0;
        let zombiesPerWave = 5;

        let zombieMoveTimer = null;
        let projectileMoveTimer = null;
        let zombieSpawnTimer = null;
        let wallnutDamageTimer = null;

        const grid = [];
        const container = document.getElementById('game-container');
        const plantPanel = document.getElementById('plant-panel');

        // ========== PLANT PANEL ==========
        function buildPlantPanel() {
            // Remove existing options (keep sun display)
            plantPanel.querySelectorAll('.plant-option').forEach(el => el.remove());

            for (let i = 0; i < PLANT_TYPES.length; i++) {
                const type = PLANT_TYPES[i];
                const option = document.createElement('div');
                option.className = 'plant-option';
                option.dataset.index = i;
                option.innerHTML = `
                    <div class="plant-preview ${type.previewClass}"></div>
                    <div class="plant-name">${type.name}</div>
                    <div class="plant-cost">${type.cost}</div>
                `;
                option.addEventListener('click', () => selectPlantType(i));
                plantPanel.appendChild(option);
            }
            updatePlantPanel();
        }

        function selectPlantType(index) {
            if (gameOver) return;
            const type = PLANT_TYPES[index];
            if (suns < type.cost) return;

            if (selectedPlantType === index) {
                selectedPlantType = null; // deselect
            } else {
                selectedPlantType = index;
            }
            updatePlantPanel();
        }

        function updatePlantPanel() {
            document.getElementById('sun-count').textContent = suns;
            const options = plantPanel.querySelectorAll('.plant-option');
            options.forEach(option => {
                const idx = parseInt(option.dataset.index);
                const type = PLANT_TYPES[idx];
                option.classList.toggle('selected', selectedPlantType === idx);
                option.classList.toggle('disabled', suns < type.cost);
            });
        }

        // ========== GRID SETUP ==========
        function buildGrid() {
            container.innerHTML = '';
            grid.length = 0;

            for (let r = 0; r < ROWS; r++) {
                grid[r] = [];
                for (let c = 0; c < COLS; c++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${r % 2 === 0 ? 'row-even' : 'row-odd'} col-${c}`;
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.addEventListener('click', () => handleCellClick(r, c));
                    container.appendChild(cell);
                    grid[r][c] = cell;
                }
            }
        }

        // ========== PLANT LOGIC ==========
        function handleCellClick(row, col) {
            if (gameOver) return;
            if (selectedPlantType === null) return;
            if (col >= COLS - 1) return; // Can't plant on last column

            const type = PLANT_TYPES[selectedPlantType];
            if (suns < type.cost) return;

            // Check if cell already has a plant
            if (plants.some(p => p.row === row && p.col === col)) return;

            // Check if cell has a zombie
            if (zombies.some(z => z.row === row && z.col === col)) return;

            placePlant(row, col, type);
            suns -= type.cost;
            selectedPlantType = null; // deselect after planting
            updatePlantPanel();
        }

        function placePlant(row, col, type) {
            const plantEl = document.createElement('div');
            plantEl.className = `plant ${type.plantClass}`;
            grid[row][col].appendChild(plantEl);

            const plant = {
                row, col, element: plantEl,
                type: type,
                hp: type.hp,
                maxHp: type.hp,
                shootInterval: null,
                sunInterval: null
            };

            // Set up shooting for shooter plants
            if (type.shootInterval) {
                plant.shootInterval = setInterval(() => {
                    if (gameOver) return;
                    shootProjectile(row, col, type);
                }, type.shootInterval);
            }

            // Set up sun production for sunflowers
            if (type.special === 'sun_producer') {
                plant.sunInterval = setInterval(() => {
                    if (gameOver) return;
                    dropSun(row, col);
                }, SUN_PRODUCE_INTERVAL);
            }

            plants.push(plant);
        }

        function removePlant(plant) {
            if (plant.shootInterval) clearInterval(plant.shootInterval);
            if (plant.sunInterval) clearInterval(plant.sunInterval);
            plant.element.remove();
            plants = plants.filter(p => p !== plant);
        }

        // ========== SUN LOGIC ==========
        function dropSun(row, col) {
            if (!grid[row] || !grid[row][col]) return;

            const sunEl = document.createElement('div');
            sunEl.className = 'sun-drop';
            grid[row][col].appendChild(sunEl);

            // Click to collect
            sunEl.addEventListener('click', (e) => {
                e.stopPropagation();
                suns += 25;
                sunEl.remove();
                updatePlantPanel();
            });

            // Auto-disappear after 8 seconds
            setTimeout(() => {
                if (sunEl.parentNode) sunEl.remove();
            }, 8000);
        }

        // ========== PROJECTILE LOGIC ==========
        function shootProjectile(fromRow, fromCol, type) {
            // Only shoot if there's a zombie in the same row to the right
            const hasTarget = zombies.some(z => z.row === fromRow && z.col > fromCol);
            if (!hasTarget) return;

            createProjectile(fromRow, fromCol, type);

            // Double shot for repeater
            if (type.special === 'double_shot') {
                setTimeout(() => {
                    if (!gameOver) createProjectile(fromRow, fromCol, type);
                }, 200);
            }
        }

        function createProjectile(fromRow, fromCol, type) {
            const projEl = document.createElement('div');
            projEl.className = `projectile ${type.projectileClass}`;
            grid[fromRow][fromCol].appendChild(projEl);

            projectiles.push({
                row: fromRow, col: fromCol,
                element: projEl,
                damage: type.damage,
                special: type.special
            });
        }

        function moveProjectiles() {
            if (gameOver) return;

            const toRemove = [];

            for (const proj of projectiles) {
                proj.element.remove();
                proj.col += 1;

                if (proj.col >= COLS) {
                    toRemove.push(proj);
                    continue;
                }

                // Check zombie collision
                const hitZombie = zombies.find(z => z.row === proj.row && z.col === proj.col);
                if (hitZombie) {
                    hitZombie.hp -= proj.damage;
                    toRemove.push(proj);

                    // Apply slow effect from snow pea
                    if (proj.special === 'slow' && !hitZombie.slowed) {
                        hitZombie.slowed = true;
                        hitZombie.element.classList.add('slowed');
                        // Slow lasts 4 seconds
                        if (hitZombie.slowTimer) clearTimeout(hitZombie.slowTimer);
                        hitZombie.slowTimer = setTimeout(() => {
                            hitZombie.slowed = false;
                            hitZombie.element.classList.remove('slowed');
                        }, 4000);
                    }

                    if (hitZombie.hp <= 0) {
                        killZombie(hitZombie);
                    }
                    continue;
                }

                grid[proj.row][proj.col].appendChild(proj.element);
            }

            for (const p of toRemove) {
                p.element.remove();
                projectiles = projectiles.filter(x => x !== p);
            }
        }

        // ========== ZOMBIE LOGIC ==========
        function spawnZombie() {
            if (gameOver) return;

            if (zombiesSpawned >= zombiesPerWave) {
                if (zombies.length === 0) nextWave();
                return;
            }

            const row = Math.floor(Math.random() * ROWS);
            const zombieEl = document.createElement('div');
            zombieEl.className = 'zombie';
            grid[row][COLS - 1].appendChild(zombieEl);

            // HP scales with wave
            const hp = 1 + Math.floor((wave - 1) / 2);

            zombies.push({
                row, col: COLS - 1, element: zombieEl,
                hp: hp,
                slowed: false, slowTimer: null,
                moveCounter: 0
            });
            zombiesSpawned++;
        }

        function moveZombies() {
            if (gameOver) return;

            for (const zombie of [...zombies]) {
                // Slowed zombies move every other tick
                if (zombie.slowed) {
                    zombie.moveCounter++;
                    if (zombie.moveCounter % 2 !== 0) continue; // skip this tick
                }

                // Check if zombie is held by a wall-nut on its current cell
                const wallnutHere = plants.find(p => p.row === zombie.row && p.col === zombie.col && p.type.id === 'wallnut');
                if (wallnutHere) continue; // Blocked â€” wall-nut damage handled by timer

                zombie.element.remove();
                zombie.col -= 1;

                // Reached left edge
                if (zombie.col < 0) {
                    triggerLose();
                    return;
                }

                // Check plant collision
                const hitPlant = plants.find(p => p.row === zombie.row && p.col === zombie.col);
                if (hitPlant) {
                    if (hitPlant.type.id !== 'wallnut') {
                        // Normal plant: deal damage
                        hitPlant.hp -= 1;
                        if (hitPlant.hp <= 0) {
                            removePlant(hitPlant);
                        }
                    }
                    // Wall-nut: zombie enters the cell and stops (damage handled by timer)
                }

                grid[zombie.row][zombie.col].appendChild(zombie.element);
            }
        }

        function killZombie(zombie) {
            if (zombie.slowTimer) clearTimeout(zombie.slowTimer);
            zombie.element.remove();
            zombies = zombies.filter(z => z !== zombie);
            kills++;
            updateStatus();

            if (zombiesSpawned >= zombiesPerWave && zombies.length === 0) {
                nextWave();
            }
        }

        // ========== WALL-NUT DURABILITY ==========
        function updateWallnutDamage() {
            if (gameOver) return;
            for (const plant of [...plants]) {
                if (plant.type.id !== 'wallnut') continue;
                const eatingCount = zombies.filter(z => z.row === plant.row && z.col === plant.col).length;
                if (eatingCount > 0) {
                    plant.hp -= eatingCount; // 1 per zombie per second
                    // Update visual
                    const pct = plant.hp / plant.maxHp;
                    if (pct < 0.33) {
                        plant.element.classList.add('wallnut-critical');
                        plant.element.classList.remove('wallnut-damaged');
                    } else if (pct < 0.66) {
                        plant.element.classList.add('wallnut-damaged');
                        plant.element.classList.remove('wallnut-critical');
                    }
                    if (plant.hp <= 0) {
                        removePlant(plant);
                    }
                }
            }
        }

        // ========== WAVES ==========
        function nextWave() {
            wave++;
            zombiesSpawned = 0;
            zombiesPerWave = 5 + (wave - 1) * 2;

            // Bonus suns each wave
            suns += 25;
            updatePlantPanel();
            updateStatus();

            clearInterval(zombieSpawnTimer);
            const spawnDelay = Math.max(1500, ZOMBIE_SPAWN_INTERVAL - (wave - 1) * 300);
            zombieSpawnTimer = setInterval(spawnZombie, spawnDelay);
        }

        // ========== GAME FLOW ==========
        function updateStatus() {
            document.getElementById('wave-count').textContent = wave;
            document.getElementById('kills-count').textContent = kills;
        }

        function triggerLose() {
            gameOver = true;
            clearAllTimers();

            const msgText = document.getElementById('message-text');
            const msgSub = document.getElementById('message-sub');
            msgText.style.color = '#e94560';
            msgText.textContent = 'Game Over!';
            msgSub.textContent = `You survived ${wave > 1 ? wave - 1 + ' waves' : 'wave 1'} and got ${kills} kills.`;
            document.getElementById('message-overlay').classList.add('active');
        }

        function clearAllTimers() {
            if (zombieMoveTimer) clearInterval(zombieMoveTimer);
            if (projectileMoveTimer) clearInterval(projectileMoveTimer);
            if (zombieSpawnTimer) clearInterval(zombieSpawnTimer);
            if (wallnutDamageTimer) clearInterval(wallnutDamageTimer);
            for (const plant of plants) {
                if (plant.shootInterval) clearInterval(plant.shootInterval);
                if (plant.sunInterval) clearInterval(plant.sunInterval);
            }
            for (const zombie of zombies) {
                if (zombie.slowTimer) clearTimeout(zombie.slowTimer);
            }
        }

        function restartGame() {
            clearAllTimers();
            for (const p of plants) p.element.remove();
            for (const z of zombies) z.element.remove();
            for (const pr of projectiles) pr.element.remove();

            plants = [];
            zombies = [];
            projectiles = [];
            kills = 0;
            wave = 1;
            suns = 50;
            zombiesSpawned = 0;
            zombiesPerWave = 5;
            gameOver = false;
            selectedPlantType = null;

            document.getElementById('message-overlay').classList.remove('active');
            buildGrid();
            buildPlantPanel();
            updateStatus();
            startTimers();
        }

        function startTimers() {
            zombieMoveTimer = setInterval(moveZombies, ZOMBIE_MOVE_INTERVAL);
            projectileMoveTimer = setInterval(moveProjectiles, PROJECTILE_MOVE_INTERVAL);
            zombieSpawnTimer = setInterval(spawnZombie, ZOMBIE_SPAWN_INTERVAL);
            wallnutDamageTimer = setInterval(updateWallnutDamage, 1000);
            setTimeout(spawnZombie, 2000);
        }

        // ========== INIT ==========
        initUserDisplay();
        buildGrid();
        buildPlantPanel();
        updateStatus();
        startTimers();
    </script>
</body>
</html>
